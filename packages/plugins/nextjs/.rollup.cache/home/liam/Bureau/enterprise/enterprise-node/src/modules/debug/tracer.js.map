{"version":3,"file":"tracer.js","sourceRoot":"","sources":["tracer.ts"],"names":[],"mappings":"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","sourcesContent":["import { SpanContext, Subscriber } from './types';\n\nexport class Span implements SpanContext {\n  readonly span_id: string;\n  readonly trace_id: string;\n  readonly parent_span_id?: string;\n  readonly name: string;\n  readonly start_time: Date;\n  metadata?: Record<string, any>;\n\n  private end_time?: Date;\n  private subscribers: Subscriber[] = [];\n  private children: Span[] = [];\n\n  constructor(\n    name: string,\n    trace_id?: string,\n    parent_span_id?: string,\n    metadata?: Record<string, any>\n  ) {\n    this.name = name;\n    this.span_id = this.generateId();\n    this.trace_id = trace_id || this.generateId();\n    this.parent_span_id = parent_span_id;\n    this.start_time = new Date();\n    this.metadata = metadata;\n  }\n\n  private generateId(): string {\n    return (\n      Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)\n    );\n  }\n\n  addSubscriber(subscriber: Subscriber): void {\n    this.subscribers.push(subscriber);\n  }\n\n  removeSubscriber(subscriber: Subscriber): void {\n    const index = this.subscribers.indexOf(subscriber);\n    if (index > -1) {\n      this.subscribers.splice(index, 1);\n    }\n  }\n\n  addChild(child: Span): void {\n    this.children.push(child);\n  }\n\n  setMetadata(metadata: Record<string, any>): void {\n    this.metadata = { ...this.metadata, ...metadata };\n  }\n\n  getDuration(): number | null {\n    if (!this.end_time) return null;\n    return this.end_time.getTime() - this.start_time.getTime();\n  }\n\n  end(): void {\n    this.end_time = new Date();\n    this.subscribers.forEach((subscriber) => subscriber.on_span_end(this));\n  }\n\n  isFinished(): boolean {\n    return this.end_time !== undefined;\n  }\n\n  toContext(): SpanContext {\n    return {\n      span_id: this.span_id,\n      trace_id: this.trace_id,\n      parent_span_id: this.parent_span_id,\n      name: this.name,\n      start_time: this.start_time,\n      metadata: this.metadata,\n    };\n  }\n\n  static createRoot(name: string, metadata?: Record<string, any>): Span {\n    const span = new Span(name, undefined, undefined, metadata);\n    return span;\n  }\n\n  static createChild(name: string, parent: SpanContext, metadata?: Record<string, any>): Span {\n    const span = new Span(name, parent.trace_id, parent.span_id, metadata);\n    return span;\n  }\n}\n\nexport class Tracer {\n  private activeSpans: Map<string, Span> = new Map();\n  private subscribers: Subscriber[] = [];\n\n  subscribe(subscriber: Subscriber): void {\n    this.subscribers.push(subscriber);\n  }\n\n  unsubscribe(subscriber: Subscriber): void {\n    const index = this.subscribers.indexOf(subscriber);\n    if (index > -1) {\n      this.subscribers.splice(index, 1);\n    }\n  }\n\n  startSpan(name: string, parent?: SpanContext, metadata?: Record<string, any>): Span {\n    const span = parent\n      ? Span.createChild(name, parent, metadata)\n      : Span.createRoot(name, metadata);\n\n    this.subscribers.forEach((subscriber) => {\n      span.addSubscriber(subscriber);\n      subscriber.on_span_start(span);\n    });\n    this.activeSpans.set(span.span_id, span);\n\n    if (parent) {\n      const parentSpan = this.activeSpans.get(parent.span_id);\n      if (parentSpan) {\n        parentSpan.addChild(span);\n      }\n    }\n\n    return span;\n  }\n\n  endSpan(span_id: string): void {\n    const span = this.activeSpans.get(span_id);\n    if (span && !span.isFinished()) {\n      span.end();\n    }\n    this.activeSpans.delete(span_id);\n  }\n\n  getActiveSpan(span_id: string): Span | undefined {\n    return this.activeSpans.get(span_id);\n  }\n\n  getActiveSpans(): Span[] {\n    return Array.from(this.activeSpans.values());\n  }\n\n  getCurrentSpan(): Span | undefined {\n    const spans = Array.from(this.activeSpans.values());\n    return spans[spans.length - 1];\n  }\n\n  inSpan<T>(\n    name: string,\n    fn: (span: Span) => T,\n    parent?: SpanContext,\n    metadata?: Record<string, any>\n  ): T {\n    const span = this.startSpan(name, parent, metadata);\n    try {\n      return fn(span);\n    } finally {\n      span.end();\n      this.activeSpans.delete(span.span_id);\n    }\n  }\n\n  async inSpanAsync<T>(\n    name: string,\n    fn: (span: Span) => Promise<T>,\n    parent?: SpanContext,\n    metadata?: Record<string, any>\n  ): Promise<T> {\n    const span = this.startSpan(name, parent, metadata);\n    try {\n      return await fn(span);\n    } finally {\n      span.end();\n      this.activeSpans.delete(span.span_id);\n    }\n  }\n\n  finishAll(): void {\n    this.activeSpans.forEach((span) => {\n      if (!span.isFinished()) {\n        span.end();\n      }\n    });\n    this.activeSpans.clear();\n  }\n}\n"]}